datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            Int           @id @default(autoincrement())
  username      String        @unique
  email         String        @unique
  has_image     Boolean       @default(false)
  password      String
  created_at    DateTime      @default(now())
  updated_at    DateTime      @default(now())
  totp_seed     String?
  wallets       Wallet[]
  event_members EventMember[]
}

model Wallet {
  id                    Int           @id @default(autoincrement())
  user                  User          @relation(fields: [user_id], references: [id])
  user_id               Int
  event                 Event         @relation(fields: [event_id], references: [id])
  event_id              Int
  coins                 Int           @default(0)
  tickets               Ticket[]
  transactions_sender   Transaction[] @relation("Sender")
  transactions_receiver Transaction[] @relation("Receiver")

  @@unique([user_id, event_id])
}

model Transaction {
  id              Int          @id @default(autoincrement())
  sender          Wallet?      @relation("Sender", fields: [sender_id], references: [id])
  sender_id       Int?
  receiver        Wallet?      @relation("Receiver", fields: [receiver_id], references: [id])
  receiver_id     Int?
  event_member    EventMember? @relation(fields: [event_member_id], references: [id])
  event_member_id Int?
  amount          Int
  created_at      DateTime     @default(now())
}

model EventMember {
  id           Int   @id @default(autoincrement())
  user         User  @relation(fields: [user_id], references: [id])
  user_id      Int
  event        Event @relation(fields: [event_id], references: [id])
  event_id     Int
  role         Role
  transactions Transaction[]

  @@unique([user_id, event_id])
}

enum Role {
  creator
  owner
  manager
  moderator
  cashier
}

model Ticket {
  id               Int          @id @default(autoincrement())
  ticket_option    TicketOption @relation(fields: [ticket_option_id], references: [id])
  ticket_option_id Int
  wallet           Wallet       @relation(fields: [wallet_id], references: [id])
  wallet_id        Int
  purchased_at     DateTime     @default(now())
  scanned_at       DateTime?
}

model TicketOption {
  id             Int        @id @default(autoincrement())
  ticket_date    TicketDate @relation(fields: [ticket_date_id], references: [id])
  ticket_date_id Int
  name           String
  price          Float      @default(0)
  amount         Int        @default(-1)
  tickets        Ticket[]
}

model TicketDate {
  id             Int            @id @default(autoincrement())
  event          Event          @relation(fields: [event_id], references: [id])
  event_id       Int
  name           String
  valid_from     DateTime?
  valid_until    DateTime?
  amount         Int            @default(-1)
  ticket_options TicketOption[]
}

model Event {
  id                Int           @id @default(autoincrement())
  name              String
  description       String?
  has_image         Boolean       @default(false)
  location          String?
  start_at          DateTime?
  end_at            DateTime?
  tickets_users_max Int           @default(-1)
  is_private        Boolean       @default(true)
  ticket_dates      TicketDate[]
  wallets           Wallet[]
  event_members     EventMember[]
}